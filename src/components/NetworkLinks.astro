---
export interface Props {
    currentCity: string;
    currentCountry: string;
    category: string;
}

const { currentCity, currentCountry, category } = Astro.props;

// Fetch other sites in the network
let networkSites = [];
let relatedCities = [];

try {
    const [sitesRes, citiesRes] = await Promise.all([
        fetch('https://www.erotikmaps.com/api/v1/satellite/api/v1/satellite/network-sites?exclude_city=' + encodeURIComponent(currentCity) + '&category=' + category + '&limit=12', {
            headers: { 'User-Agent': 'Astro/Netlify-Build', 'Accept': 'application/json' }
        }),
        fetch('https://www.erotikmaps.com/api/v1/satellite/api/v1/satellite/related-cities?country=' + encodeURIComponent(currentCountry.toLowerCase().replace(/ /g, '-')) + '&exclude_city=' + encodeURIComponent(currentCity) + '&limit=8', {
            headers: { 'User-Agent': 'Astro/Netlify-Build', 'Accept': 'application/json' }
        })
    ]);
    
    if (sitesRes.ok) {
        const sitesData = await sitesRes.json();
        networkSites = sitesData.sites || [];
    }
    if (citiesRes.ok) {
        const citiesData = await citiesRes.json();
        relatedCities = citiesData.cities || [];
    }
} catch (e) {
    console.error('Failed to fetch network links:', e);
}

// Get a random anchor text for each site
function getRandomAnchor(site) {
    const anchors = site.anchor_texts || [site.city + ' ' + site.category];
    return anchors[Math.floor(Math.random() * anchors.length)];
}
---

{(networkSites.length > 0 || relatedCities.length > 0) && (
    <section class="network-links">
        <div class="container">
            <h2>üåç Explore Our Network</h2>
            <p class="network-intro">Discover erotic massage & adult entertainment venues across Europe and beyond</p>
            
            {relatedCities.length > 0 && (
                <div class="network-section">
                    <h3>üìç More Cities in {currentCountry}</h3>
                    <div class="city-links">
                        {relatedCities.map((city) => (
                            <a href={city.url} class="city-link" rel="dofollow" title={'Erotic massage in ' + city.city}>
                                {city.city}
                            </a>
                        ))}
                    </div>
                </div>
            )}
            
            {networkSites.length > 0 && (
                <div class="network-section">
                    <h3>üó∫Ô∏è Popular Destinations</h3>
                    <div class="sites-grid">
                        {networkSites.slice(0, 8).map((site) => (
                            <a href={site.url} class="site-card" rel="dofollow" title={getRandomAnchor(site)}>
                                <span class="site-city">{site.city}</span>
                                <span class="site-country">{site.country}</span>
                            </a>
                        ))}
                    </div>
                </div>
            )}
            
            <div class="network-cta">
                <p>Looking for a specific city? Check the full <a href="https://erotikmaps.com/erotic-massage" rel="dofollow">ErotikMaps directory</a> for all locations worldwide.</p>
            </div>
        </div>
    </section>
)}

<style>
    .network-links {
        background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 70px 0;
        border-top: 1px solid var(--border);
    }
    
    .network-links h2 {
        text-align: center;
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 12px;
    }
    
    .network-intro {
        text-align: center;
        color: var(--text-light);
        margin-bottom: 40px;
        font-size: 1.1rem;
    }
    
    .network-section {
        margin-bottom: 40px;
    }
    
    .network-section h3 {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
        color: var(--text);
    }
    
    /* City Links - Pills style */
    .city-links {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 12px;
    }
    
    .city-link {
        display: inline-block;
        padding: 10px 22px;
        background: white;
        color: var(--text);
        border-radius: 30px;
        font-weight: 500;
        font-size: 0.95rem;
        text-decoration: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        transition: all 0.3s ease;
        border: 1px solid var(--border);
    }
    
    .city-link:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(233, 30, 99, 0.25);
        text-decoration: none;
    }
    
    /* Sites Grid - Cards */
    .sites-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        max-width: 900px;
        margin: 0 auto;
    }
    
    @media (max-width: 900px) {
        .sites-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 500px) {
        .sites-grid {
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
    }
    
    .site-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px 16px;
        background: white;
        border-radius: 12px;
        text-decoration: none;
        box-shadow: 0 2px 12px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        border: 1px solid transparent;
    }
    
    .site-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-color: var(--primary);
        text-decoration: none;
    }
    
    .site-city {
        font-weight: 700;
        font-size: 1.05rem;
        color: var(--text);
        margin-bottom: 4px;
    }
    
    .site-country {
        font-size: 0.85rem;
        color: var(--text-light);
    }
    
    /* CTA */
    .network-cta {
        text-align: center;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 1px solid var(--border);
    }
    
    .network-cta p {
        color: var(--text-light);
        font-size: 0.95rem;
    }
    
    .network-cta a {
        color: var(--primary);
        font-weight: 600;
    }
    
    .network-cta a:hover {
        text-decoration: underline;
    }
</style>